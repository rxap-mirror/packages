image: node:lts

stages:
- build
- test
- publish

setup:
  stage: .pre
  tags:
  - build
  script: yarn --prefer-offline
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success

build:
  stage: build
  tags:
  - build
  needs:
  - setup
  script: yarn nx run-many --target=build --all --with-deps
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success

test:
  stage: test
  tags:
  - build
  script: yarn nx run-many --target=test --all --with-deps
  needs:
  - setup
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success
    allow_failure: true

build:publish:
  stage: build
  tags:
  - build
  needs:
  - setup
  script: yarn nx run-many --target=pack --projects="$(echo $CI_COMMIT_TAG | cut -d'@' -f2 | cut -d'/' -f2)" --with-deps
  cache:
    policy: pull
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
  artifacts:
    paths:
    - dist
    expire_in: 7 days
  rules:
  - if: '$CI_COMMIT_TAG =~ /.+@\d+\.\d+\.\d+/'
    when: always

.publish:
  stage: publish
  image: registry.gitlab.com/rxap/gitlab-ci/angular-build
  tags:
  - build
  needs:
  - build:publish
  rules:
  - if: '$CI_COMMIT_TAG =~ /.+@\d+\.\d+\.\d+/'
    when: on_success
    allow_failure: true
  script:
  - echo "@${CI_PROJECT_ROOT_NAMESPACE}:registry=$NPM_REGISTRY" >> .npmrc
  - git update-index --assume-unchanged .npmrc
  - PROJECT="$(echo $CI_COMMIT_TAG | cut -d'@' -f2 | cut -d'/' -f2)"
  - echo "PROJECT=${PROJECT}"
  - DIST_PATH="dist/$(cat angular.json | jq --arg name $PROJECT -r '.projects[$name].root')"
  - echo "DIST_PATH=${DIST_PATH}"
  - cd $DIST_PATH
  - npm publish --registry $NPM_REGISTRY

publish:npm:
  extends: .publish
  before_script:
  - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}">.npmrc
  rules:
  - if: '$CI_COMMIT_TAG =~ /.+@\d+\.\d+\.\d+/'
    when: manual
    allow_failure: true
  variables:
    NPM_REGISTRY: https://registry.npmjs.org

publish:rxap:
  extends: .publish
  before_script:
  - echo "//npm.rxap.dev/:_authToken=${RXAP_NPM_TOKEN}">.npmrc
  variables:
    NPM_REGISTRY: https://npm.rxap.dev

publish:gitlab:
  extends: .publish
  before_script:
  - echo "${CI_API_V4_URL#https?}/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=\${CI_JOB_TOKEN}">.npmrc
  variables:
    NPM_REGISTRY: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/"
