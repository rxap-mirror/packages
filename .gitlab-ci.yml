image: node:lts

stages:
- build
- test
- publish

setup:
  stage: .pre
  tags:
  - build
  script: yarn --prefer-offline
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success

build:
  stage: build
  tags:
  - build
  needs:
  - setup
  before_script:
  - yarn --prefer-offline
  script: yarn nx run-many --target=build --all --with-deps
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success

test:
  stage: test
  tags:
  - build
  before_script:
  - yarn --prefer-offline
  script: yarn nx run-many --target=test --all --with-deps
  needs:
  - setup
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success
    allow_failure: true

build:publish:
  stage: build
  tags:
  - build
  before_script:
  - yarn --prefer-offline
  script: yarn nx run-many --target=pack --projects="$(echo $CI_COMMIT_TAG | cut -d'@' -f2 | cut -d'/' -f2)" --with-deps
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
  rules:
  - if: '$CI_COMMIT_TAG =~ /@rxap\/.+@\d+\.\d+\.\d+/'
    when: always

.publish:
  tags:
  - build
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG =~ /@rxap\/.+@\d+\.\d+\.\d+/'
    when: on_success
    allow_failure: true
  script: yarn lerna publish from-git --yes --registry $NPM_REGISTRY

publish:npm:
  extends: .publish
  before_script:
  - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}">.npmrc
  - git config --global user.email "ci@gitlab.com"
  - git config --global user.name "Gitlab CI"
  - git commit -anm "tmp"
  rules:
  - if: '$CI_COMMIT_TAG =~ /@rxap\/.+@\d+\.\d+\.\d+/'
    when: manual
    allow_failure: true
  variables:
    NPM_REGISTRY: https://registry.npmjs.org

publish:rxap:
  extends: .publish
  before_script:
  - echo "//npm.rxap.dev/:_authToken=${RXAP_NPM_TOKEN}">.npmrc
  - git config --global user.email "ci@gitlab.com"
  - git config --global user.name "Gitlab CI"
  - git commit -anm "tmp"
  variables:
    NPM_REGISTRY: https://npm.rxap.dev

publish:gitlab:
  extends: .publish
  before_script:
  - echo "//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}">.npmrc
  - git config --global user.email "ci@gitlab.com"
  - git config --global user.name "Gitlab CI"
  - git commit -anm "tmp"
  variables:
    NPM_REGISTRY: "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm"
