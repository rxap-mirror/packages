image: node:lts

stages:
- build
- test
- publish

setup:
  stage: .pre
  tags:
  - build
  script: yarn --prefer-offline
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success

build:
  stage: build
  tags:
  - build
  needs:
  - setup
  script: yarn nx run-many --target=build --all --with-deps
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success

test:
  stage: test
  tags:
  - build
  script: yarn nx run-many --target=test --all --with-deps
  needs:
  - setup
  cache:
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
    policy: pull
  rules:
  - if: '$CI_COMMIT_TAG'
    when: never
  - when: on_success
    allow_failure: true

build:publish:
  stage: build
  tags:
  - build
  before_script:
  - yarn --prefer-offline
  script: yarn nx run-many --target=pack --projects="$(echo $CI_COMMIT_TAG | cut -d'@' -f2 | cut -d'/' -f2)" --with-deps
  cache:
    policy: pull
    key:
      files:
      - yarn.lock
    paths:
    - node_modules/
  artifacts:
    paths:
    - dist
    expire_in: 7 days
  rules:
  - if: '$CI_COMMIT_TAG =~ /.+@\d+\.\d+\.\d+/'
    when: always

.publish:
  stage: publish
  image: registry.gitlab.com/rxap/gitlab-ci/angular-build
  tags:
  - build
  needs:
  - build:publish
  rules:
  - if: '$CI_COMMIT_TAG =~ /.+@\d+\.\d+\.\d+/'
    when: on_success
    allow_failure: true
  variables:
    PACKAGE_ACCESS: public
  script:
  - echo "" > .npmrc
  - npm config set "@${CI_PROJECT_ROOT_NAMESPACE}:registry $PACKAGE_REGISTRY"
  - npm config set "${PACKAGE_REGISTRY#https?}:_authToken=${PACKAGE_REGISTRY_TOKEN}"
  - cat .npmrc
  - npm --version
  - npm ping --registry $PACKAGE_REGISTRY
  - npm whoami || true
  - PROJECT="$(echo $CI_COMMIT_TAG | cut -d'@' -f2 | cut -d'/' -f2)"
  - echo "PROJECT=${PROJECT}"
  - DIST_PATH="dist/$(cat angular.json | jq --arg name $PROJECT -r '.projects[$name].root')"
  - echo "DIST_PATH=${DIST_PATH}"
  - cd $DIST_PATH
  - npm publish --registry $PACKAGE_REGISTRY --access $PACKAGE_ACCESS

publish:npm:
  extends: .publish
  variables:
    PACKAGE_REGISTRY: https://registry.npmjs.org/
    PACKAGE_REGISTRY_TOKEN: "$NPM_TOKEN"

publish:rxap:
  extends: .publish
  variables:
    PACKAGE_REGISTRY: https://npm.rxap.dev/
    PACKAGE_REGISTRY_TOKEN: "$RXAP_NPM_TOKEN"

.check_gitlab_token: &check_gitlab_token |
  if [[ "${CI_JOB_TOKEN}" == *"-"* ]]; then
    echo "The CI_JOB_TOKEN contains a dash!!"
    exit 1
  fi

publish:gitlab:
  extends: .publish
  before_script:
  - *check_gitlab_token
  variables:
    PACKAGE_REGISTRY: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/"
    PACKAGE_REGISTRY_TOKEN: "$CI_JOB_TOKEN"
