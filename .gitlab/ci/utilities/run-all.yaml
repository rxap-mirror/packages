.run_all:
  stage: build
  image: node:${NODE_VERSION}-alpine
  variables:
    TARGET: "$CI_JOB_NAME"
  before_script:
    - apk add --no-cache git g++ make python3
    - corepack enable
    - corepack prepare yarn@stable --activate
    - yarn "$(if [[ $CI_COMMIT_REF_NAME =~ ^renovate//* ]]; then echo ''; else echo '--frozen-lockfile'; fi)"
  script:
    - yarn nx run-many --target ${TARGET} --parallel $NX_PARALLEL ${ADDITIONAL_TARGET_OPTIONS}
    - yarn nx run packages:ci-info
  rules:
    - exists:
        - nx.json
      when: on_success
  artifacts:
    name: "${CI_COMMIT_REF_SLUG}_run-all_${TARGET}"
    paths:
      - dist
