setup:
  stage: .pre
  tags:
    - e2-standard-2
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache git g++ make python3
    - corepack enable
    - corepack prepare yarn@stable --activate
  script: |
    if [[ $CI_COMMIT_REF_NAME =~ ^renovate//* ]]; then
      yarn --refresh-lockfile
    else
      if [[ -d node_modules ]] && [[ -d .yarn/cache ]]; them
        # without --immutable-cache, yarn will try to update the cache
        yarn --immutable
      else
       echo "WARNING: No node_modules or .yarn/cache directory found."
       yarn
      fi
    fi
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules
      - .yarn/cache
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true" && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/'
      when: never
    - if: '$CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"'
      when: never
    - if: '$CI_COMMIT_REF_NAME =~ /^renovate\//'
      when: always
    - if: '$ENFORCE_SETUP == "true"'
      when: always
    - changes:
        - yarn.lock
      when: always

job:
  stage: .pre
  script: echo job
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED != "true" && $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_COMMIT_BRANCH !~ /^renovate\//'
