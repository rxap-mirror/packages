pages:
  image: registry.gitlab.com/rxap/gitlab-ci/apindex:latest
  stage: .post
  needs:
    - coverage-report
  script: |
    if [ ! -d public ]; then
      echo "No public directory found, create a new one"
    fi
    output="public/${CI_COMMIT_REF_SLUG}"
    mkdir -p "$output"
    echo "Folder structure of the public directory:"
    ls -l public
    echo "Copy coverage report to $output"
    cp -r coverage/* "$output/"
    echo "create index.html"
    apindex public
  environment:
    name: "pages/$CI_COMMIT_REF_NAME"
    deployment_tier: other
    url: $CI_PAGES_URL/$CI_COMMIT_REF_SLUG
  allow_failure: true
  cache:
    # storage all page contents into one global cache
    # only one page can exist per project
    key: pages_$CI_PROJECT_ID
    paths:
      - public
  artifacts:
    expire_in: 1 week
    paths:
      - public
